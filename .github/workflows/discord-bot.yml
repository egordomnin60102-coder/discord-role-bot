name: Discord Bot CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: üì¶ Restore dependencies
      run: |
        cd bot
        dotnet restore
        
    - name: üèóÔ∏è Build project
      run: |
        cd bot
        dotnet build -c Release --no-restore
        
    - name: üß™ Run tests
      run: |
        echo "‚úÖ Build successful!"
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
        
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: discord-bot
        path: bot/bin/Release/net8.0/
        retention-days: 7

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
    - name: üì• Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: discord-bot
        path: bot
        
    - name: ü§ñ Run Discord Bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ Discord Bot..."
        cd bot
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–æ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if [ -n "$DISCORD_TOKEN" ]; then
          echo "‚úÖ –¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        else
          echo "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –Ω–∞ 6 —á–∞—Å–æ–≤
        echo "‚è∞ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ 6 —á–∞—Å–æ–≤..."
        timeout 360m dotnet ./bot.dll || echo "üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
        
    - name: üìä Send notification
      if: always()
      run: |
        echo "üì® Workflow –∑–∞–≤–µ—Ä—à–µ–Ω: ${{ job.status }}"
